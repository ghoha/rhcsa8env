---
- name: Setting Up IPA Server
  hosts: ipa
  strategy: free
  ignore_errors: true
  tasks:
  - name: Setting Up Python
    file:
      src: /usr/bin/python3.6
      path: /usr/bin/python
      state: link
  - name: Setting Hostname
    hostname: name=ipa.eight.example.com
  - name: Adjusting sftp
    lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^Subsystem'
      line: 'Subsystem sftp internal-sftp'
  - name: Building Host File
    copy:
      dest: /etc/hosts
      content: "127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n:1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.55.149 repo.eight.example.com repo\n192.168.55.150 server1.eight.example.com server1\n192.168.55.151 server2.eight.example.com server2\n192.168.55.5 ipa.eight.example.com ipa"
      force: yes
  - name: Creating Temporary Repo File
    file:
      path: /etc/yum.repos.d/rpms.repo
      state: touch
      mode: 0755
  - name: Building Repo File
    copy:
      dest: /etc/yum.repos.d/rpms.repo
      content: "[base]\nname=Base\nbaseurl=http://repo/BaseOS\ngpgcheck=0\nenabled=1\n\n[apps]\nname=Apps\nbaseurl=http://repo/AppStream\ngpgcheck=0\nenabled=1"
      force: yes
  - name: Enabling yum module
    command: "dnf module -y install idm:DL1/dns "
  - name: Packages Installed
    yum:
      name: "{{ item }}"
      state: present
    with_items:
      - chrony
      - sshpass
      - python3-pip
      - python3-devel
      - vsftpd
      - httpd
  - name: Configuring IPV6
    block:
      - name: Enabling ipv6 on lo
        blockinfile:
          dest: /etc/sysctl.conf
          block: |
            net.ipv6.conf.lo.disable_ipv6 = 0
            net.ipv6.conf.eth0.disable_ipv6 = 1
            net.ipv6.conf.eth1.disable_ipv6 = 1
      - name: Reading systemctl
        command: sysctl -p
  - name: Configuring network
    shell: nmcli con mod 'System eth1' ipv4.addresses 192.168.55.5/24 ipv4.gateway 192.168.55.1 ipv4.dns 8.8.8.8 ipv4.dns-search eight.example.com ipv4.method manual
  - name: Restarted Network
    service: name=NetworkManager state=restarted
  - name: Starting services
    service: name=firewalld state=started enabled=yes
  - name: Enabling Firewall Services. Configuring IPA server...(Est. Time - 7 minutes)
    firewalld:
      service: "{{ item }}"
      immediate: yes
      permanent: yes
      state: enabled
    with_items:
      - http
      - https
      - ntp
      - dns
      - kerberos
      - ldap
      - ldaps
      - ftp
  - name: Starting services
    service: name={{item}} enabled=true state=started
    with_items:
      - httpd
      - chronyd
  - name: Configuring IPA Server
    block:
      - name: Finishing IPA server Configuration
        command: ipa-server-install --setup-dns --allow-zone-overlap --auto-reverse -a 'password' --hostname=ipa.eight.example.com -r EIGH.EXAMPLE.COM -p 'password' -n eight.example.com -U --forwarder 8.8.8.8
    rescue:
      - debug:
          msg: "An error occured during the IPA server installation, reverting back..."
      - name: Uninstalling Failed IPA Configuration
        command: ipa-server-install --uninstall
  - name: Authenticating KRB5 Database
    expect:
      command: kinit admin
      responses:
        (.*)Password for admin@EIGH.EXAMPLE.COM(.*): 'password'
    tags: krb
  - name: Setting IPA user home directory location
    command: ipa config-mod --homedirectory /home/ldap
    tags: krb
  - name: Adding IPA user 'dave'
    ipa_user:
        name: dave
        state: present
        krbpasswordexpiration: '20200119235959'
        givenname: dave
        sn: dave
        mail:
        - dave@eight.example.com
        telephonenumber:
        - '+555123456'
        sshpubkey:
        password: password
        uidnumber: '1001'
        gidnumber: '1000'
        ipa_host: ipa.eight.example.com
        ipa_user: admin
        ipa_pass: password
  - name: Adding IPA user 'lisa'
    ipa_user:
        name: lisa
        state: present
        krbpasswordexpiration: '20200119235959'
        givenname: lisa
        sn: lisa
        mail:
        - lisa@eight.example.com
        telephonenumber:
        - '+555123456'
        sshpubkey:
        password: password
        uidnumber: '1002'
        gidnumber: '1001'
        ipa_host: ipa.eight.example.com
        ipa_user: admin
        ipa_pass: password
  - name: Copying CA CERT
    copy:
      src: /etc/ipa/ca.crt
      dest: /var/www/html/ca.crt
      remote_src: yes
  - name: Creating Welcome Message
    file:
      path: /etc/profile.d/welcome.sh
      state: touch
      mode: 0755
  - name: Building Welcome Message
    blockinfile:
      dest: /etc/profile.d/welcome.sh
      block: |
         #!/bin/bash
         #
         echo -e '
         #             _         _         _
         #           /\ \      /\ \      / /\
         #           \ \ \    /  \ \    / /  \
         #           /\ \_\  / /\ \ \  / / /\ \
         #          / /\/_/ / / /\ \_\/ / /\ \ \
         #         / / /   / / /_/ / / / /  \ \ \
         #        / / /   / / /__\/ / / /___/ /\ \
         #       / / /   / / /_____/ / /_____/ /\ \
         #   ___/ / /__ / / /     / /_________/\ \ \
         #  /\__\/_/___/ / /     / / /_       __\ \_\
         #  \/_________\/_/      \_\___\     /____/_/
         '"#
         # Why are you here? You should be working on the system hosts...
         # Anyway, try not to reboot me or bad stuff can happen.
         #
         # You are logged into \"`hostname`\" as the \"`whoami`\" account.
         # This system is running `cat /etc/redhat-release`
         "

  - name: Creating lisa home for nfs export
    file:
      path: /ldaphome/lisa
      state: directory
      owner: lisa
      group: lisa
      mode: '0700'
  - name: Creating dave home for nfs export
    file:
      path: /ldaphome/dave
      state: directory
      owner: dave
      group: dave
      mode: '0700'
  - name: Adjusting Services then Rebooting
    selinux:
      policy: targeted
      state: permissive
...
